import os
import re
import time
import json
import telebot
import openai
import tempfile
import pytesseract
from telebot import types
from gtts import gTTS
from PIL import Image
from google_trans_new import google_translator
from apscheduler.schedulers.background import BackgroundScheduler

print("Current working directory:", os.getcwd())

# ====== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ù…ÙØ§ØªÙŠØ­ ======
TELEGRAM_BOT_TOKEN = "6669452404:AAHlWVC275ljXZaU03Yi7td9fBwruEm_PF8"
OPENAI_API_KEY = "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"

# Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…ÙˆØ°Ø¬ GPT-3.5-turbo
GPT_MODEL_ID = "gpt-3.5-turbo"

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø±ÙˆØ¨ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
GROUP_LINK = "https://t.me/NOOR200009"
GROUP_USERNAME = "@NOOR200009"

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
ADMIN_IDS = [5545208360]  # Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ù‚Ù… Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙƒØ£Ø¯Ù…Ù†
ADMIN_USERNAMES = ["muneeralhu"]  # Ø£Ùˆ Ø¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø£Ø¯Ù…Ù† (Ø¨Ø¯ÙˆÙ† @)

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
openai.api_key = OPENAI_API_KEY
bot = telebot.TeleBot(TELEGRAM_BOT_TOKEN)
translator = google_translator()

# Get bot info for referral link generation.
bot_info = bot.get_me()
bot_username = bot_info.username

# ====== Ù…Ù„ÙØ§Øª JSON ======
SUBSCRIBERS_FILE = "subscribers.json"
PRO_SUBSCRIBERS_FILE = "prosubscribers.json"
BALANCE_FILE = "balances.json"  # Ù„Ø­ÙØ¸ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…

# In-memory referral database: maps referral_code -> referrer's chat_id.
referral_db = {}
# To ensure that a referral is credited only once per new user.
referred_users = set()

# Ø¯ÙˆØ§Ù„ ØªØ­Ù…ÙŠÙ„/Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
def load_subscribers():
    if not os.path.exists(SUBSCRIBERS_FILE):
        return set()
    try:
        with open(SUBSCRIBERS_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
        return set(data)
    except:
        return set()

def save_subscribers(subs):
    with open(SUBSCRIBERS_FILE, "w", encoding="utf-8") as f:
        json.dump(list(subs), f, ensure_ascii=False)

def load_pro_subscribers():
    if not os.path.exists(PRO_SUBSCRIBERS_FILE):
        return set()
    try:
        with open(PRO_SUBSCRIBERS_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
        return set(data)
    except:
        return set()

def save_pro_subscribers(pro_subs):
    with open(PRO_SUBSCRIBERS_FILE, "w", encoding="utf-8") as f:
        json.dump(list(pro_subs), f, ensure_ascii=False)

subscribers = load_subscribers()
magical_subscribers = load_pro_subscribers()

print(f"Loaded {len(subscribers)} subscribers from {SUBSCRIBERS_FILE}")
print(f"Loaded {len(magical_subscribers)} pro subscribers from {PRO_SUBSCRIBERS_FILE}")

# ===== Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ø¯Ø§Ø¯ =====
# Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ù…Ù† 20 Ø±Ø³Ø§Ù„Ø© (Ø«Ù… Ø§Ù„Ø´Ø­Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ 15 Ø±Ø³Ø§Ù„Ø©)
daily_recharge_amount = 15  # Ø³ÙŠØªÙ… Ø´Ø­Ù† 15 Ø±Ø³Ø§Ù„Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„ØºØ¯ Ø§Ù„Ø³Ø§Ø¹Ø© 8 Ù…Ø³Ø§Ø¡Ù‹

def load_balances():
    if os.path.exists(BALANCE_FILE):
        with open(BALANCE_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}

def save_balances(balances):
    with open(BALANCE_FILE, "w", encoding="utf-8") as f:
        json.dump(balances, f, ensure_ascii=False)

balances = load_balances()  # Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† chat_id ÙƒÙ†Øµ

admin_broadcast_mode = False
admin_adding_subscriber = False
admin_add_channel_members = False
user_modes = {}  # Stores current mode ("translate", "transliteration", "magic", "homework")

# ========== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù‚Ø±ÙˆØ¨ ==========
def check_subscription(user_id):
    try:
        member = bot.get_chat_member(GROUP_USERNAME, user_id)
        if member.status in ["left", "kicked"]:
            return False
        return True
    except:
        return False

# ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø¯Ù…Ù† ==========
def is_admin(user):
    if user.id in ADMIN_IDS:
        return True
    if user.username and user.username.lower() in [u.lower() for u in ADMIN_USERNAMES]:
        return True
    return False

@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if not is_admin(message.from_user):
        bot.reply_to(message, "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„.")
        return
    markup = types.InlineKeyboardMarkup()
    btn_subscribers_count = types.InlineKeyboardButton("Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†", callback_data="subscriber_count")
    btn_broadcast = types.InlineKeyboardButton("Ø¨Ø« Ø±Ø³Ø§Ù„Ø©", callback_data="broadcast")
    btn_add_subscriber = types.InlineKeyboardButton("Add Magical Subscriber", callback_data="add_subscriber")
    btn_add_channel = types.InlineKeyboardButton("Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø©", callback_data="add_from_channel")
    markup.row(btn_subscribers_count, btn_broadcast)
    markup.row(btn_add_subscriber, btn_add_channel)
    bot.send_message(message.chat.id, "ğŸ”’ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†:", reply_markup=markup)

# ===== Ø¯ÙˆØ§Ù„ Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ =====
def send_magic_congrats(user_id):
    msg = (
        "ØªÙ… Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­ ğŸ¤–ğŸŒ¹\n"
        "Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø§Ù„ÙØ§Ø¦Ø¯Ø© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ù† ØªÙ‚Ø¶ÙŠ ÙˆÙ‚ØªÙ‹Ø§ Ø¬Ù…ÙŠÙ„Ù‹Ø§ Ù…Ø¹Ù†Ø§!"
    )
    bot.send_message(user_id, msg)

# ===== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ§Ù„ØªØ¹Ø±ÙŠØ¨ =====
def get_transliteration(text):
    prompt = (
        "Ø£Ø±Ø¬Ùˆ Ù…Ù†Ùƒ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ù„Ù‰ Ø¹Ø±Ø¨Ù†Ø© ØµÙˆØªÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø±ÙˆÙ Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø· ØªØ¹Ø¨Ø± Ø¹Ù† Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„ÙƒÙ„ ÙƒÙ„Ù…Ø©. "
        "Ù„Ø§ ØªÙ‚Ù… Ø¨ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†ØµØŒ Ø¨Ù„ Ù‚Ù… Ø¨Ù†Ù‚Ù„ Ø§Ù„Ø£ØµÙˆØ§Øª ÙƒÙ…Ø§ ØªÙ†Ø·Ù‚ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¥Ù„Ù‰ Ù…Ø§ ÙŠÙ‚Ø§Ø¨Ù„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©. "
        "Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ: 'my name is sarah'ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ø§ØªØ¬: 'Ù…Ø§ÙŠ Ù†ÙŠÙ… Ø§Ø² Ø³Ø§Ø±Ø§'.\n\n"
        f"Ø§Ù„Ù†Øµ: {text}\n\nØ§Ù„Ø¹Ø±Ø¨Ù†Ø©:"
    )
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=150,
        temperature=0.3,
    )
    return response["choices"][0]["message"]["content"].strip()

# Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ÙƒØ§Ø¨Ø´Ù† Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ
def send_magicbot_image(chat_id):
    features_text = (
        "âœ¨ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ:\n\n"
        "1. Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„ØªØ¹Ø±ÙŠØ¨.\n"
        "2. ØªØ¹Ø±ÙŠØ¨ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø·ÙˆÙŠÙ„Ø© Ø¨Ø¯Ù‚Ø©.\n"
        "3. Ù…Ù„Ù ØµÙˆØªÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„Ù†Ø·Ù‚.\n"
        "4. Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ± ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ù…Ù†Ù‡Ø§ Ø¨Ø¯Ù‚Ø©.\n"
        "5. Ø³Ø±Ø¹Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙØ§Ø¦Ù‚Ø©.\n"
        "6. Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…Ø¨Ø§Ø´Ø±.\n"
        "7. ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ø³ØªÙ…Ø±Ø©.\n\n"
        "ğŸ’° Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: 30 Ø±ÙŠØ§Ù„ Ø´Ù‡Ø±ÙŠ\n"
        "Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ù†ÙˆØ±: @Noor_teacher2"
    )
    try:
        with open("magicbot.png", "rb") as photo:
            bot.send_photo(chat_id, photo, caption=features_text)
    except Exception as e:
        bot.send_message(chat_id, f"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© (magicbot.png). Ø§Ù„Ø®Ø·Ø£: {str(e)}")

def get_gpt_voice(text):
    with tempfile.NamedTemporaryFile(delete=False, suffix=".mp3") as tmp:
        temp_filename = tmp.name
    tts = gTTS(text=text, lang='en')
    tts.save(temp_filename)
    return temp_filename

# Append footer shows available attempts as "available/500"
def append_footer(chat_id, response_text):
    if chat_id in magical_subscribers:
        footer = "\n----------------------------------------\nØ­Ø³Ø§Ø¨ Ù…Ø¯ÙÙˆØ¹ (ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)"
    else:
        available = balances.get(str(chat_id), 0)
        footer = f"\n----------------------------------------\n{available}/500"
    return response_text + footer

def send_magic_response(chat_id, text):
    if chat_id not in magical_subscribers:
        bot.send_message(chat_id, "â—ï¸ Ø£Ù†Øª ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ.\nØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ù†ÙˆØ±: @Noor_teacher2")
        return
    transliteration = get_transliteration(text)
    prompt = (
        f"Please translate the following English text to Arabic in a professional and accurate manner.\n"
        f"Text:\n{text}\n\nTranslation:"
    )
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=200,
        temperature=0.3,
    )
    translated = response["choices"][0]["message"]["content"].strip()
    response_text = (
        "<b>Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ:</b>\n"
        "ğŸ”¹ <b>Ø§Ù„Ø¹Ø±Ø¨Ù†Ø©:</b>\n\n" + transliteration + "\n\n"
        "----------------------------------------\n"
        "ğŸ”¹ <b>Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†ØµÙŠØ©:</b>\n\n" + translated
    )
    response_text = append_footer(chat_id, response_text)
    bot.send_message(chat_id, response_text, parse_mode="HTML")
    temp_filename = get_gpt_voice(text)
    with open(temp_filename, 'rb') as audio:
        bot.send_voice(chat_id, audio)
    os.remove(temp_filename)

def send_regular_response(chat_id, text):
    transliteration = get_transliteration(text)
    response_text = "<b>Ø§Ù„ØªØ¹Ø±ÙŠØ¨:</b>\n\n" + transliteration
    response_text = append_footer(chat_id, response_text)
    bot.send_message(chat_id, response_text, parse_mode="HTML")
    tts = gTTS(text=text, lang='en')
    with tempfile.NamedTemporaryFile(delete=False, suffix=".mp3") as tmp:
        temp_filename = tmp.name
    tts.save(temp_filename)
    with open(temp_filename, 'rb') as audio:
        bot.send_voice(chat_id, audio)
    os.remove(temp_filename)

def send_translate_response(chat_id, text):
    prompt = (
        f"Please translate the following English text to Arabic in a professional and accurate manner.\n"
        f"Text:\n{text}\n\nTranslation:"
    )
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=200,
        temperature=0.3,
    )
    translated = response["choices"][0]["message"]["content"].strip()
    response_text = "<b>Ø§Ù„ØªØ±Ø¬Ù…Ø©:</b>\n\n" + translated
    response_text = append_footer(chat_id, response_text)
    bot.send_message(chat_id, response_text, parse_mode="HTML")

# Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª: Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØªÙƒÙˆÙ† Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„ØºØ§Ù…Ù‚ ÙˆØªØ­ØªÙ‡Ø§ Ø®Ø·.
def send_homework_response(chat_id, text):
    prompt = ("Please help me solve the following English homework problem. Provide a clear explanation and then provide the final answer in bold and underlined.\nHomework:\n" + text)
    response = openai.ChatCompletion.create(
         model="gpt-3.5-turbo",
         messages=[{"role": "user", "content": prompt}],
         max_tokens=250,
         temperature=0.3,
    )
    answer = response["choices"][0]["message"]["content"].strip()
    formatted_answer = f"<b><u>{answer}</u></b>"
    bot.send_message(chat_id, formatted_answer, parse_mode="HTML")

def process_image_and_get_text(message):
    file_id = message.photo[-1].file_id
    file_info = bot.get_file(file_id)
    downloaded_file = bot.download_file(file_info.file_path)
    image_path = "temp_image.jpg"
    with open(image_path, 'wb') as f:
        f.write(downloaded_file)
    try:
        extracted_text = pytesseract.image_to_string(Image.open(image_path), lang='eng')
    except Exception as e:
        extracted_text = ""
    os.remove(image_path)
    return extracted_text

# ØªØºÙŠÙŠØ± ØªØ®Ø·ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø±: ÙƒÙ„ Ø²Ø± ÙŠØ¸Ù‡Ø± ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„.
def get_main_keyboard():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    btn_translate = types.KeyboardButton("Ø§Ù„ØªØ±Ø¬Ù…Ø©")
    btn_transliteration = types.KeyboardButton("Ø§Ù„ØªØ¹Ø±ÙŠØ¨")
    btn_magic = types.KeyboardButton("Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ")
    btn_homework = types.KeyboardButton("Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª")
    markup.row(btn_translate)
    markup.row(btn_transliteration)
    markup.row(btn_magic)
    markup.row(btn_homework)
    return markup

# /start command with referral integration.
@bot.message_handler(commands=['start'])
def start_command(message):
    chat_id = message.chat.id
    parts = message.text.split()
    referral_code = parts[1] if len(parts) > 1 else None

    if not check_subscription(chat_id):
        markup = types.InlineKeyboardMarkup()
        btn_sub = types.InlineKeyboardButton("Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨", url=GROUP_LINK)
        markup.add(btn_sub)
        bot.send_message(chat_id, "ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.", reply_markup=markup)
        return

    # Process referral if provided: Ø¥Ø¶Ø§ÙØ© 10 Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…ÙØ­ÙŠÙ„.
    if referral_code:
        referrer_chat_id = referral_db.get(referral_code)
        if referrer_chat_id and referrer_chat_id != chat_id and chat_id not in referred_users:
            balances[str(referrer_chat_id)] = balances.get(str(referrer_chat_id), 0) + 10
            save_balances(balances)
            referred_users.add(chat_id)
            bot.send_message(referrer_chat_id, "Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 10 Ø±Ø³Ø§Ø¦Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø³Ø¨Ø¨ Ø¥Ø­Ø§Ù„ØªÙƒ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯!")
    
    # Initialize balance for non-paid users: Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ 20 Ø±Ø³Ø§Ù„Ø©.
    if chat_id not in magical_subscribers:
        if str(chat_id) not in balances:
            balances[str(chat_id)] = 20
            save_balances(balances)

    # Generate a referral code for the user if not exists.
    if str(chat_id) not in referral_db:
        referral_db[str(chat_id)] = chat_id
    referral_link = f"https://t.me/{bot_username}?start={str(chat_id)}"
    
    # Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø· Ù†ØµØ§Ù‹.
    inline_kb = types.InlineKeyboardMarkup()
    btn_ref = types.InlineKeyboardButton("Ø¨ÙˆØª Ù†Ø§Ø·Ù‚", url=referral_link)
    inline_kb.add(btn_ref)
    
    welcome_message = "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø§Ø®ØªØ± ÙˆØ¶Ø¹Ùƒ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„."
    bot.send_message(chat_id, welcome_message, reply_markup=get_main_keyboard())
    bot.send_message(chat_id, "Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ 10 Ø±Ø³Ø§Ø¦Ù„ Ù…Ù‚Ø§Ø¨Ù„ ÙƒÙ„ Ø´Ø®Øµ ÙŠØ¯Ø®Ù„ Ø§Ù„Ø¨ÙˆØª Ø¹Ø¨Ø± Ù…Ø´Ø§Ø±ÙƒØªÙƒ", reply_markup=inline_kb)

# Automatically send referral link when attempts are exhausted.
def send_referral_message(chat_id):
    referral_link = f"https://t.me/{bot_username}?start={str(chat_id)}"
    inline_kb = types.InlineKeyboardMarkup()
    btn_ref = types.InlineKeyboardButton("Ø¨ÙˆØª Ù†Ø§Ø·Ù‚", url=referral_link)
    inline_kb.add(btn_ref)
    message_text = (
        "Ù„Ù‚Ø¯ Ø§Ù†ØªÙ‡Øª Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.\n"
        "ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø´Ø­Ù† Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù…Ø¹ Ø²Ù…Ù„Ø§Ø¦Ùƒ.\n"
        "Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ 10 Ø±Ø³Ø§Ø¦Ù„ Ù…Ù‚Ø§Ø¨Ù„ ÙƒÙ„ Ø´Ø®Øµ ÙŠØ¯Ø®Ù„ Ø§Ù„Ø¨ÙˆØª Ø¹Ø¨Ø± Ù…Ø´Ø§Ø±ÙƒØªÙƒ."
    )
    bot.send_message(chat_id, message_text, reply_markup=inline_kb)

@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    global admin_broadcast_mode, admin_adding_subscriber, admin_add_channel_members
    chat_id = call.message.chat.id
    user = call.from_user
    data = call.data
    if not check_subscription(chat_id):
        bot.answer_callback_query(call.id, "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ø£ÙˆÙ„Ù‹Ø§.", show_alert=True)
        return
    if data == "subscriber_count":
        if not is_admin(user):
            bot.answer_callback_query(call.id, "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.", show_alert=True)
            return
        bot.send_message(chat_id, f"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†: {len(subscribers)}")
    elif data == "broadcast":
        if not is_admin(user):
            bot.answer_callback_query(call.id, "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.", show_alert=True)
            return
        admin_broadcast_mode = True
        bot.send_message(chat_id, "Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¨Ø«Ù‡Ø§.")
    elif data == "add_subscriber":
        if not is_admin(user):
            bot.answer_callback_query(call.id, "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.", show_alert=True)
            return
        admin_adding_subscriber = True
        bot.send_message(chat_id, "Ø£Ø¹Ø¯ ØªÙˆØ¬ÙŠÙ‡ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ.")
    elif data == "add_from_channel":
        if not is_admin(user):
            bot.answer_callback_query(call.id, "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.", show_alert=True)
            return
        admin_add_channel_members = True
        bot.send_message(chat_id, "Ù‚Ù… Ø§Ù„Ø¢Ù† Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø© (Ø­ÙŠØ« Ù†Ø´Ø± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡) Ø¥Ù„Ù‰ Ù‡Ù†Ø§ØŒ ÙˆØ³Ø£Ø¶ÙŠÙ Ù…Ø±Ø³Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.")
    try:
        bot.answer_callback_query(call.id)
    except:
        pass

@bot.message_handler(content_types=['text'])
def handle_text(message):
    chat_id = message.chat.id
    text = message.text.strip()
    user = message.from_user
    if not check_subscription(chat_id):
        markup = types.InlineKeyboardMarkup()
        btn_sub = types.InlineKeyboardButton("Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨", url=GROUP_LINK)
        markup.add(btn_sub)
        bot.send_message(chat_id, "ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.", reply_markup=markup)
        return
    if chat_id not in subscribers:
        subscribers.add(chat_id)
        save_subscribers(subscribers)
    
    # Mode selection: ÙƒÙ„ Ø²Ø± ÙŠØ¸Ù‡Ø± ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„.
    if text in ["Ø§Ù„ØªØ±Ø¬Ù…Ø©", "Ø§Ù„ØªØ¹Ø±ÙŠØ¨", "Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ", "Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª"]:
        if text == "Ø§Ù„ØªØ±Ø¬Ù…Ø©":
            bot.send_message(chat_id, "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ù„ØªØ±Ø¬Ù…Ø©.")
            user_modes[chat_id] = "translate"
            return
        elif text == "Ø§Ù„ØªØ¹Ø±ÙŠØ¨":
            bot.send_message(chat_id, "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ù„ØªØ¹Ø±ÙŠØ¨ Ø§Ù„ØµÙˆØªÙŠ.")
            user_modes[chat_id] = "transliteration"
            return
        elif text == "Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ":
            send_magicbot_image(chat_id)
            user_modes[chat_id] = "magic"
            return
        elif text == "Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª":
            if chat_id in magical_subscribers:
                bot.send_message(chat_id, "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ø­Ù„Ù‡.")
                user_modes[chat_id] = "homework"
            else:
                bot.send_message(chat_id, "Ù„Ø§ ØªÙ…ØªÙ„Ùƒ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ. Ø³ÙŠØªÙ… ÙØªØ­ Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ù…Ø¹ Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠ.")
                user_modes[chat_id] = "magic"
            return

    # Ù„ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© ÙŠØªÙ… Ø®ØµÙ… Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù† Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŒ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ù…Ù†.
    if not is_admin(user) and (chat_id not in magical_subscribers):
        if str(chat_id) not in balances:
            balances[str(chat_id)] = 20
        if balances.get(str(chat_id), 0) < 1:
            bot.reply_to(message, "Ù„Ù‚Ø¯ Ø§Ù†ØªÙ‡Øª Ø±Ø³Ø§Ø¦Ù„Ùƒ Ø§Ù„Ù…ØªØ§Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø´Ø­Ù†Ù‡Ø§ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù…Ø¹ Ø²Ù…Ù„Ø§Ø¦Ùƒ. Ø¥Ø°Ø§ Ø¯Ø®Ù„ Ø£Ø­Ø¯Ù‡Ù… Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ 10 Ø±Ø³Ø§Ø¦Ù„ Ø¥Ø¶Ø§ÙÙŠØ©.")
            send_referral_message(chat_id)
            return
        balances[str(chat_id)] -= 1
        save_balances(balances)
    
    if chat_id in user_modes:
        mode = user_modes[chat_id]
        if mode == "magic":
            send_magic_response(chat_id, text)
        elif mode == "transliteration":
            send_regular_response(chat_id, text)
        elif mode == "translate":
            send_translate_response(chat_id, text)
        elif mode == "homework":
            send_homework_response(chat_id, text)
        return

    if re.search(r'[\u0600-\u06FF]', text):
        bot.reply_to(message, "â—ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·.")
        return

    bot.reply_to(message, "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ.")

@bot.message_handler(content_types=['photo'])
def handle_photo(message):
    chat_id = message.chat.id
    user = message.from_user
    if not check_subscription(chat_id):
        markup = types.InlineKeyboardMarkup()
        btn_sub = types.InlineKeyboardButton("Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨", url=GROUP_LINK)
        markup.add(btn_sub)
        bot.send_message(chat_id, "ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.", reply_markup=markup)
        return
    if chat_id not in subscribers:
        subscribers.add(chat_id)
        save_subscribers(subscribers)
    global admin_add_channel_members
    if admin_add_channel_members and is_admin(user):
        if message.forward_from:
            old_id = message.forward_from.id
            subscribers.add(old_id)
            save_subscribers(subscribers)
            bot.send_message(chat_id, f"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ID {old_id} Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.")
        else:
            bot.send_message(chat_id, "Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ù…Ø¹Ø§Ø¯ ØªÙˆØ¬ÙŠÙ‡Ù‡Ø§ Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù….")
        return
    if chat_id in user_modes:
        mode = user_modes[chat_id]
        extracted_text = process_image_and_get_text(message)
        if not extracted_text.strip():
            bot.reply_to(message, "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Øµ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­.")
            return
        if not is_admin(user) and (chat_id not in magical_subscribers):
            if str(chat_id) not in balances:
                balances[str(chat_id)] = 20
            if balances.get(str(chat_id), 0) < 1:
                bot.reply_to(message, "Ù„Ù‚Ø¯ Ø§Ù†ØªÙ‡Øª Ø±Ø³Ø§Ø¦Ù„Ùƒ Ø§Ù„Ù…ØªØ§Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø´Ø­Ù†Ù‡Ø§ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù…Ø¹ Ø²Ù…Ù„Ø§Ø¦Ùƒ. Ø¥Ø°Ø§ Ø¯Ø®Ù„ Ø£Ø­Ø¯Ù‡Ù… Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ 10 Ø±Ø³Ø§Ø¦Ù„ Ø¥Ø¶Ø§ÙÙŠØ©.")
                send_referral_message(chat_id)
                return
            balances[str(chat_id)] -= 1
            save_balances(balances)
        if mode == "magic":
            send_magic_response(chat_id, extracted_text)
        elif mode == "transliteration":
            send_regular_response(chat_id, extracted_text)
        elif mode == "translate":
            send_translate_response(chat_id, extracted_text)
        elif mode == "homework":
            send_homework_response(chat_id, extracted_text)
        return
    bot.reply_to(message, "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ (Ø§Ù„ØªØ±Ø¬Ù…Ø©ØŒ Ø§Ù„ØªØ¹Ø±ÙŠØ¨ØŒ Ø§Ù„Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø±ÙŠØŒ Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª) Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±.")

# Ø¯Ø§Ù„Ø© Ø§Ù„Ø´Ø­Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ: ØªÙØ¶ÙŠÙ 15 Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ ÙˆØªÙ†Ø¨Ù‡Ù‡.
def daily_recharge():
    for chat_id in subscribers:
        if chat_id not in magical_subscribers:
            current = balances.get(str(chat_id), 0)
            new_val = current + daily_recharge_amount
            balances[str(chat_id)] = new_val
            try:
                bot.send_message(chat_id, f"ğŸ Ù‡Ø¯ÙŠØ© Ø´Ø­Ù†: ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© 15 Ø±Ø³Ø§Ù„Ø©. Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: {new_val}/500")
            except Exception as e:
                print(f"Error notifying user {chat_id}: {e}")
    save_balances(balances)
    print("Daily recharge completed.")

scheduler = BackgroundScheduler(timezone="Asia/Riyadh")
scheduler.add_job(daily_recharge, 'cron', hour=20, minute=0)
scheduler.start()

def run_bot():
    while True:
        try:
            print("Bot is polling...")
            bot.polling(none_stop=True, interval=2, timeout=20)
        except Exception as e:
            print(f"Bot polling error: {e}")
            time.sleep(15)

if __name__ == "__main__":
    run_bot()
